# 🚀 BruV Nexus Prompt 系統 v2.0 - 完整指南

## 📋 版本資訊

**版本**: v2.0 增強版  
**更新日期**: 2026-02-05  
**文件位置**: `backend/api/graph_import.py`  
**函數**: `build_node_analysis_prompt()`

---

## ✨ v2.0 新增功能

### 1️⃣ **領域特化 - IDP 企業級知識圖譜**

**角色定位**:
```
IDP Co., Ltd. 的企業級知識圖譜架構師
```

**專精領域**:
- 📋 數據處理流程分析（身份驗證、文件處理、資料連貫性）
- 🔗 跨系統整合設計（API 串接、數據同步、流程自動化）
- 🧠 智能知識萃取（技術文檔、業務流程、最佳實踐）

### 2️⃣ **質量控制系統**

#### **標題 (label) 驗證**
- ✅ 長度：3-10 字
- ✅ 支持中英文混合（如：OAuth 2.0 驗證流程）
- ✅ 優先級：技術關鍵詞 > 業務概念 > 通用描述

**範例對比**:
```
✅ 好：「JWT Token 刷新機制」、「GDPR 個資保護合規」
❌ 差：「關於系統的說明」、「文件內容」
```

#### **描述 (description) 結構化**
- ✅ 字數：200-250 字（v1.0 為 150 字）
- ✅ 必須包含四個部分：

```markdown
【背景】此知識的來源場景、觸發條件或前置需求
【核心內容】關鍵技術點、流程步驟或業務邏輯（使用條列式）
【實際應用】可解決的問題、適用場景、預期效益
【注意事項】潛在風險、限制條件或最佳實踐建議
```

### 3️⃣ **多語言支持優化**

- ✅ 自動識別中英文混合內容
- ✅ 技術術語保留英文（OAuth、JWT、API）
- ✅ 業務描述使用繁體中文
- ✅ metadata.language 標記（zh-TW / en-US）

### 4️⃣ **上下文記憶功能**

**節點概覽生成**:
```python
📊 現有知識圖譜概覽
**節點總數**: 45 個
**類型分佈**: 技術架構: 12個, API介面: 8個, 數據流程: 10個

⚠️ 重要: 避免創建與現有節點高度相似的內容
```

**智能去重**:
- 分析前 25 個最相關節點
- 提供節點 ID、名稱、類型、描述摘要
- 建議建立連線而非重複創建

---

## 🔗 六維關係分析系統（v2.0 核心創新）

### **v1.0 vs v2.0 對比**

| 版本 | 關係類型數量 | 關係定義 |
|------|------------|---------|
| v1.0 | 3 種 | 因果、互補、衝突 |
| v2.0 | 6 種 | 因果、依賴、時序、包含、互補、對比 |

### **關係類型詳解**

#### 1. **因果關係 (causality)**
```
定義: A 是 B 的前提條件、觸發因素或直接原因
方向: A → B
範例: 「用戶認證成功」 → 「授權令牌生成」
```

#### 2. **依賴關係 (dependency)**
```
定義: A 的運作需要 B 的支持或 A 調用 B 的功能
方向: A → B（A 依賴 B）
範例: 「前端登錄頁面」 → 「身份驗證 API」
```

#### 3. **時序關係 (sequence)**
```
定義: A 在時間順序上先於 B 執行
方向: A → B → C（流程鏈）
範例: 「數據採集」 → 「數據清洗」 → 「數據分析」
```

#### 4. **包含關係 (composition)**
```
定義: A 是 B 的組成部分或子模組
方向: B ◇→ A（B 包含 A）
範例: 「OAuth 系統」 包含 「Token 管理」、「Scope 權限」
```

#### 5. **互補關係 (complement)**
```
定義: A 與 B 共同完成某個目標，缺一不可
方向: A ←→ B（雙向）
範例: 「資料加密」 ←→ 「密鑰管理」
```

#### 6. **對比關係 (contrast)**
```
定義: A 與 B 是不同的實現方案或存在權衡取捨
方向: A — B（無方向性）
範例: 「Session 驗證」 vs 「JWT 驗證」
```

---

## 🎯 標準知識類型系統

### **8 大核心類型**

| 類型 | 說明 | 範例 |
|------|------|------|
| `技術架構` | 系統設計、框架選型、技術棧 | 微服務架構設計、Docker 容器化方案 |
| `API介面` | 端點定義、參數規範、響應格式 | RESTful API 規範、GraphQL Schema |
| `數據流程` | ETL、資料轉換、處理邏輯 | 用戶數據同步流程、報表生成邏輯 |
| `安全規範` | 驗證機制、加密方式、權限控制 | OAuth 2.0 實作、HTTPS 憑證配置 |
| `業務流程` | 工作流、審批流程、操作指南 | 訂單處理流程、客戶服務 SOP |
| `最佳實踐` | 編碼規範、設計模式、優化方案 | 代碼審查標準、性能優化指南 |
| `問題排查` | 錯誤處理、除錯技巧、故障恢復 | 常見錯誤診斷、系統監控配置 |
| `配置文檔` | 環境設定、參數說明、部署指南 | 環境變數配置、CI/CD 流程 |

### **自訂類型規範**
若不符合標準類型，請使用：
- 2-4 字的專業術語
- 範例：`監控告警`、`資料遷移`、`測試案例`

---

## 📦 輸出 Schema（JSON 格式）

### **完整結構**

```json
{
  "label": "JWT Token 刷新機制",
  "description": "【背景】當 Access Token 過期時，系統需要在不重新登錄的情況下獲取新令牌...",
  "type": "安全規範",
  "links": [
    {
      "target_id": "node_auth_001",
      "relation": "causality",
      "reason": "Token 過期是觸發刷新機制的直接原因，用戶認證成功後才會頒發 Refresh Token"
    }
  ],
  "metadata": {
    "confidence": 0.92,
    "keywords": ["JWT", "Token", "Refresh", "OAuth 2.0"],
    "language": "zh-TW"
  }
}
```

### **欄位說明**

| 欄位 | 類型 | 必填 | 說明 | 驗證規則 |
|------|------|------|------|---------|
| `label` | string | ✅ | 節點標題 | 3-20 字 |
| `description` | string | ✅ | 深度描述 | 50-500 字（建議 200-250） |
| `type` | string | ✅ | 知識類型 | 標準類型或 2-4 字自訂 |
| `links` | array | ❌ | 連線推薦 | 最多 5 個 |
| `metadata` | object | ❌ | 元數據 | 自動生成 |

---

## 🛠️ 使用範例

### **情境 1：分析 API 文檔**

**輸入內容**:
```
POST /api/v1/users/login
Request: { "email": "user@example.com", "password": "xxx" }
Response: { "access_token": "...", "refresh_token": "...", "expires_in": 3600 }
```

**LLM 輸出**:
```json
{
  "label": "用戶登錄 API v1",
  "description": "【背景】提供用戶身份驗證的 RESTful 端點...",
  "type": "API介面",
  "links": [
    {
      "target_id": "jwt_token_node",
      "relation": "causality",
      "reason": "登錄成功後生成 JWT Token 作為後續請求的憑證..."
    }
  ],
  "metadata": {
    "confidence": 0.95,
    "keywords": ["REST API", "Authentication", "JWT"],
    "language": "zh-TW"
  }
}
```

### **情境 2：分析業務流程**

**輸入內容**:
```
訂單處理流程：
1. 用戶提交訂單
2. 檢查庫存
3. 扣款
4. 生成配送單
5. 更新訂單狀態
```

**LLM 輸出**:
```json
{
  "label": "電商訂單處理流程",
  "description": "【背景】從訂單提交到配送的完整業務流程...",
  "type": "業務流程",
  "links": [
    {
      "target_id": "inventory_check_node",
      "relation": "sequence",
      "reason": "庫存檢查必須在扣款之前執行，避免超賣問題..."
    },
    {
      "target_id": "payment_gateway_node",
      "relation": "dependency",
      "reason": "扣款操作依賴第三方支付閘道的 API..."
    }
  ],
  "metadata": {
    "confidence": 0.88,
    "keywords": ["訂單", "庫存", "支付", "配送"],
    "language": "zh-TW"
  }
}
```

---

## 🔍 質量檢查清單

使用以下清單驗證 LLM 輸出是否符合標準：

- [ ] **label**: 是否具備專業性且無歧義？長度 3-20 字？
- [ ] **description**: 是否包含【背景】【核心內容】【實際應用】【注意事項】四部分？
- [ ] **type**: 是否使用標準類型或合理的自訂類型？
- [ ] **links**: 每個連線的 reason 是否具體且有說服力（50-100 字）？
- [ ] **JSON 格式**: 是否完全正確（無額外字符、無 Markdown 包裹）？
- [ ] **metadata**: confidence、keywords、language 是否合理？

---

## 🚀 進階配置

### **調整 Prompt 參數**

**位置**: `backend/api/graph_import.py` Line 18-183

**可調整項目**:
1. **角色定位** (Line 40)
   ```python
   prompt = f"""你是 IDP Co., Ltd. 的...  # 可改為您的公司名稱
   ```

2. **描述字數** (Line 78)
   ```python
   **字數**: 200-250 字  # 可調整為 150-300
   ```

3. **連線數量** (Line 138)
   ```python
   - 每個新節點建議 **2-5 個連線**  # 可調整範圍
   ```

4. **節點上下文** (Line 31)
   ```python
   for node in existing_nodes[:25]  # 可調整為 10-50
   ```

### **整合 RAGFlow**

Prompt 系統可與 RAGFlow 協同工作：

1. **RAGFlow** 負責：
   - 文檔解析與向量化
   - 語義搜索與知識檢索
   - RAPTOR 層次化摘要

2. **BruV Prompt** 負責：
   - 知識圖譜節點生成
   - 智能連線推薦
   - 結構化知識提取

**協同流程**:
```
文檔上傳 → RAGFlow 解析 → 文本分段 → 
BruV Prompt 分析 → 生成節點 → KuzuDB 存儲 → 
前端可視化
```

---

## 📊 性能優化建議

### **Token 使用優化**
- 限制現有節點數量（25 個）
- 使用節點摘要而非完整描述
- 類型統計代替詳細列表

### **響應速度優化**
- 使用 `qwen2.5:14b` 本地模型（速度適中）
- 或升級到 `qwen2.5:32b`（質量更高但較慢）
- 避免使用過大的模型（如 70B）

### **質量與速度平衡**

| 模型 | Token 處理速度 | 輸出質量 | 推薦場景 |
|------|--------------|---------|---------|
| qwen2.5:7b | ⚡⚡⚡ 快 | ⭐⭐⭐ 良好 | 快速測試 |
| qwen2.5:14b | ⚡⚡ 中等 | ⭐⭐⭐⭐⭐ 優秀 | **生產環境** |
| qwen2.5:32b | ⚡ 較慢 | ⭐⭐⭐⭐⭐⭐ 頂級 | 高質量需求 |

---

## 🔄 版本歷史

### v2.0 (2026-02-05)
- ✨ 新增：IDP 領域特化
- ✨ 新增：六維關係分析系統
- ✨ 新增：結構化描述模板
- ✨ 新增：8 大標準知識類型
- ✨ 新增：metadata 元數據支持
- 🔧 優化：描述字數從 150 提升到 200-250
- 🔧 優化：節點上下文從 20 提升到 25
- 🔧 優化：新增 JSON 驗證與清洗

### v1.0 (初始版本)
- 基礎 Prompt 框架
- 3 種關係類型
- 150 字描述

---

## 📞 技術支持

如有問題或建議，請參考：
- 📖 主文檔：`README.md`
- 🔗 API 文檔：`docs/api/GRAPH_API_FIX_REPORT.md`
- 🎨 前端指南：`frontend/README.md`

**快速測試**:
```bash
# 啟動後端
python app_anytype.py

# 測試上傳（會觸發 Prompt 系統）
python test_upload.py
```

---

🎉 **v2.0 已全面升級，開始享受更智能的知識圖譜生成！**
