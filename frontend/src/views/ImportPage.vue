<template>
  <div class="min-h-screen bg-gray-50 dark:bg-gradient-to-br dark:from-[#0a0a0a] dark:to-[#1a1a2e] px-12 py-10">
    <!-- é é¢æ¨™é¡Œ -->
    <header class="text-center mb-12">
      <div class="flex flex-col items-center gap-3">
        <h1 class="flex items-center gap-4 m-0 text-5xl font-extrabold text-gray-800 dark:text-white">
          <span class="text-6xl">ğŸ“¥</span>
          <span class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">è³‡æ–™å°å…¥å·¥ä½œå°</span>
        </h1>
        <p class="text-base font-medium text-gray-500 dark:text-gray-400 uppercase tracking-widest m-0">Data Import Workbench</p>
      </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <div class="max-w-5xl mx-auto">
      <!-- å°å…¥èªªæ˜å¡ç‰‡ -->
      <div class="mb-8 p-6 bg-blue-50 dark:bg-blue-900/10 border-2 border-blue-200 dark:border-blue-500/30 rounded-2xl">
        <div class="flex items-start gap-4">
          <span class="text-4xl">ğŸ’¡</span>
          <div class="flex-1">
            <h3 class="text-xl font-bold text-blue-800 dark:text-blue-300 mb-2">æ”¯æ´æ ¼å¼</h3>
            <ul class="space-y-2 text-gray-700 dark:text-gray-300">
              <li class="flex items-center gap-2">
                <span class="text-green-500">âœ“</span>
                <strong>CSV æª”æ¡ˆ</strong> (.csv) - é€—è™Ÿåˆ†éš”å€¼
              </li>
              <li class="flex items-center gap-2">
                <span class="text-green-500">âœ“</span>
                <strong>Excel æª”æ¡ˆ</strong> (.xlsx) - Microsoft Excel æ ¼å¼
              </li>
              <li class="flex items-center gap-2 mt-3">
                <span class="text-blue-500">â„¹ï¸</span>
                <span>æª”æ¡ˆå°‡è‡ªå‹•è§£æä¸¦å»ºç«‹ç‚ºçŸ¥è­˜ç¯€é»ï¼Œå„²å­˜è‡³æ–°åœ–è­œ</span>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- å°å…¥æ“ä½œå¡ç‰‡ -->
      <div class="bg-white dark:bg-[#1a1a1a] border-2 border-gray-200 dark:border-white/10 rounded-3xl shadow-xl">
        <!-- å¡ç‰‡æ¨™é¡Œ -->
        <div class="px-8 py-6 bg-gradient-to-r from-blue-500 to-purple-500 border-b border-white/10">
          <h2 class="text-2xl font-bold text-white flex items-center gap-3">
            <span class="text-3xl">ğŸ“‚</span>
            é¸æ“‡æª”æ¡ˆ
          </h2>
        </div>

        <!-- ä¸Šå‚³å€åŸŸ -->
        <div class="p-12 pb-16">
          <!-- å°å…¥æ¨¡å¼é¸æ“‡ -->
          <div class="mb-8">
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
              ğŸ“‹ å°å…¥æ¨¡å¼
            </label>
            <div class="flex gap-4">
              <button
                @click="importMode = 'new'"
                class="flex-1 px-6 py-4 rounded-xl border-2 transition-all"
                :class="importMode === 'new' 
                  ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-500 text-blue-700 dark:text-blue-300 font-bold' 
                  : 'bg-white dark:bg-white/5 border-gray-300 dark:border-white/20 text-gray-600 dark:text-gray-400 hover:border-blue-400'"
              >
                <div class="flex flex-col items-center gap-2">
                  <span class="text-2xl">âœ¨</span>
                  <span class="text-base">å»ºç«‹æ–°åœ–è­œ</span>
                </div>
              </button>
              <button
                @click="importMode = 'existing'"
                class="flex-1 px-6 py-4 rounded-xl border-2 transition-all"
                :class="importMode === 'existing' 
                  ? 'bg-purple-50 dark:bg-purple-900/20 border-purple-500 text-purple-700 dark:text-purple-300 font-bold' 
                  : 'bg-white dark:bg-white/5 border-gray-300 dark:border-white/20 text-gray-600 dark:text-gray-400 hover:border-purple-400'"
              >
                <div class="flex flex-col items-center gap-2">
                  <span class="text-2xl">ğŸ“‚</span>
                  <span class="text-base">åŠ å…¥ç¾æœ‰åœ–è­œ</span>
                </div>
              </button>
            </div>
          </div>
          
          <!-- æ–°å»ºåœ–è­œï¼šåœ–è­œåç¨±è¼¸å…¥ -->
          <div v-if="importMode === 'new'" class="mb-8">
            <label class="block text-sm font-bold text-blue-700 dark:text-blue-300 mb-3">
              âœ¨ æ–°åœ–è­œåç¨±
            </label>
            <input 
              v-model="graphName"
              type="text"
              placeholder="ä¾‹å¦‚ï¼š2024 å¹´åº¦å ±å‘Šã€ç”¢å“è¦åŠƒ..."
              class="w-full px-6 py-4 bg-white dark:bg-white/5 border-2 border-blue-300 dark:border-blue-500/50 rounded-xl text-lg text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
            />
            <p class="mt-2 text-sm text-blue-600 dark:text-blue-400">
              ğŸ’¡ åŒ¯å…¥çš„æ•¸æ“šå°‡å»ºç«‹ç‚ºä¸€å€‹å…¨æ–°çš„çŸ¥è­˜åœ–è­œ
            </p>
          </div>
          
          <!-- ç¾æœ‰åœ–è­œï¼šä¸‹æ‹‰é¸æ“‡ -->
          <div v-if="importMode === 'existing'" class="mb-8">
            <label class="block text-sm font-bold text-purple-700 dark:text-purple-300 mb-3">
              ğŸ“‚ é¸æ“‡åœ–è­œ
            </label>
            <div v-if="isLoadingGraphs" class="w-full px-6 py-4 bg-white dark:bg-white/5 border-2 border-purple-300 dark:border-purple-500/50 rounded-xl text-center">
              <span class="text-gray-500 dark:text-gray-400">â³ è¼‰å…¥åœ–è­œåˆ—è¡¨ä¸­...</span>
            </div>
            <select
              v-else
              v-model="selectedGraphId"
              class="w-full px-6 py-4 bg-white dark:bg-white/5 border-2 border-purple-300 dark:border-purple-500/50 rounded-xl text-lg text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all cursor-pointer"
            >
              <option :value="null" disabled>è«‹é¸æ“‡è¦åŠ å…¥çš„åœ–è­œ...</option>
              <option v-for="graph in existingGraphs" :key="graph.id" :value="graph.id">
                {{ graph.name }} ({{ graph.nodeCount }} å€‹ç¯€é»)
              </option>
            </select>
            <p class="mt-2 text-sm text-purple-600 dark:text-purple-400 flex items-center gap-1">
              <span>ğŸ’¡</span>
              <span>åŒ¯å…¥çš„æ•¸æ“šå°‡åŠ å…¥åˆ°é¸å®šçš„åœ–è­œä¸­</span>
            </p>
            <button
              v-if="!isLoadingGraphs"
              @click="loadExistingGraphs"
              class="mt-2 text-xs text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 underline"
            >
              ğŸ”„ é‡æ–°è¼‰å…¥åœ–è­œåˆ—è¡¨
            </button>
          </div>
          
          <div 
            class="relative flex flex-col items-center justify-center gap-6 p-16 border-3 border-dashed border-gray-300 dark:border-gray-600 rounded-2xl bg-gray-50 dark:bg-white/5 hover:bg-gray-100 dark:hover:bg-white/10 hover:border-blue-400 dark:hover:border-blue-500 transition-all duration-300 cursor-pointer group"
            @click="triggerFileInput"
          >
            <!-- åœ–ç¤º -->
            <div class="text-8xl opacity-60 group-hover:opacity-100 group-hover:scale-110 transition-all duration-300">
              ğŸ“
            </div>

            <!-- æç¤ºæ–‡å­— -->
            <div class="text-center">
              <p class="text-xl font-bold text-gray-700 dark:text-gray-200 mb-2">
                é»æ“Šé¸æ“‡æª”æ¡ˆ
              </p>
              <p class="text-base text-gray-500 dark:text-gray-400">
                æ”¯æ´ CSV æˆ– Excel æª”æ¡ˆ
              </p>
            </div>

            <!-- å·²é¸æª”æ¡ˆé¡¯ç¤º -->
            <div v-if="selectedFile" class="mt-4 px-6 py-3 bg-blue-100 dark:bg-blue-900/30 border border-blue-300 dark:border-blue-500/40 rounded-xl flex items-center gap-3">
              <span class="text-2xl">ğŸ“„</span>
              <div class="flex-1 flex flex-col items-start">
                <span class="text-sm font-bold text-blue-800 dark:text-blue-300">{{ selectedFile.name }}</span>
                <span class="text-xs text-blue-600 dark:text-blue-400">{{ formatFileSize(selectedFile.size) }}</span>
                
                <!-- ä¸Šå‚³é€²åº¦æ¢ -->
                <div v-if="isUploading" class="w-full mt-2">
                  <div class="flex items-center gap-2">
                    <div class="flex-1 h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                      <div 
                        class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-300"
                        :style="{ width: uploadProgress + '%' }"
                      ></div>
                    </div>
                    <span class="text-xs text-blue-600 dark:text-blue-400 font-mono">{{ Math.round(uploadProgress) }}%</span>
                  </div>
                </div>
              </div>
              <button 
                v-if="!isUploading"
                @click.stop="clearFile"
                class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition-colors"
              >
                âœ• å–æ¶ˆ
              </button>
            </div>

            <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥ -->
            <input 
              ref="fileInput" 
              type="file" 
              accept=".csv, .xlsx" 
              style="display: none;" 
              @change="handleFileSelect"
            />
          </div>

          <!-- å°å…¥æŒ‰éˆ• -->
          <div class="mt-8 flex justify-center">
            <button 
              :disabled="!selectedFile || (importMode === 'new' && !graphName.trim()) || (importMode === 'existing' && !selectedGraphId) || isUploading"
              @click="handleUpload"
              class="px-12 py-4 flex items-center gap-3 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed text-white rounded-xl text-lg font-bold shadow-lg shadow-blue-500/30 transition-all duration-200 hover:-translate-y-1 disabled:translate-y-0 disabled:shadow-none"
            >
              <span class="text-2xl">{{ isUploading ? 'â³' : 'ğŸš€' }}</span>
              <span>{{ isUploading ? 'ä¸Šå‚³ä¸­...' : 'é–‹å§‹å°å…¥' }}</span>
            </button>
          </div>

          <!-- æª”æ¡ˆé è¦½å€åŸŸ -->
          <div v-if="filePreview && filePreview.type === 'csv' && filePreview.headers" class="mt-8 p-6 bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl">
            <h3 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-4 flex items-center gap-2">
              <span class="text-xl">ğŸ‘ï¸</span>
              æª”æ¡ˆé è¦½ (å‰ 5 åˆ—)
            </h3>
            <div class="overflow-x-auto">
              <table class="w-full text-xs">
                <thead>
                  <tr class="bg-blue-100 dark:bg-blue-900/20">
                    <th v-for="(header, index) in filePreview.headers" :key="index" class="px-3 py-2 text-left text-gray-700 dark:text-gray-300 border-r border-gray-300 dark:border-gray-600 last:border-r-0">
                      {{ header.trim() }}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(row, rowIndex) in filePreview.rows" :key="rowIndex" class="border-t border-gray-200 dark:border-gray-700">
                    <td v-for="(cell, cellIndex) in row" :key="cellIndex" class="px-3 py-2 text-gray-600 dark:text-gray-400 border-r border-gray-200 dark:border-gray-700 last:border-r-0">
                      {{ cell.trim() }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- æœ€è¿‘å°å…¥è¨˜éŒ„ -->
      <div v-if="importHistory.length > 0" class="mt-8 bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-white/10 rounded-2xl shadow-lg overflow-hidden">
        <div class="px-6 py-4 bg-gray-100 dark:bg-white/5 border-b border-gray-200 dark:border-white/10 flex items-center justify-between">
          <h3 class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2">
            <span class="text-xl">ğŸ“‹</span>
            å°å…¥è¨˜éŒ„
            <span class="ml-2 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-xs rounded-lg">{{ importHistory.length }}</span>
          </h3>
          <button 
            @click="clearAllHistory"
            class="px-3 py-1 bg-red-500/10 hover:bg-red-500/20 text-red-600 dark:text-red-400 text-sm rounded-lg transition-colors flex items-center gap-1"
          >
            <span>ğŸ—‘ï¸</span>
            <span>æ¸…ç©ºå…¨éƒ¨</span>
          </button>
        </div>
        <div class="p-6">
          <div class="space-y-3">
            <div 
              v-for="(record, index) in importHistory" 
              :key="index"
              class="flex items-center justify-between p-4 bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl hover:bg-gray-100 dark:hover:bg-white/10 transition-colors group"
            >
              <div class="flex items-center gap-3 flex-1">
                <span class="text-2xl">{{ record.success ? 'âœ…' : 'âŒ' }}</span>
                <div class="flex-1">
                  <p class="font-semibold text-gray-800 dark:text-white">{{ record.fileName }}</p>
                  <p class="text-xs" :class="record.mode === 'new' ? 'text-blue-600 dark:text-blue-400' : 'text-purple-600 dark:text-purple-400'" v-if="record.graphName">
                    {{ record.mode === 'new' ? 'âœ¨' : 'ğŸ“‚' }} {{ record.graphName }}
                  </p>
                  <p class="text-sm text-gray-500 dark:text-gray-400">{{ record.timestamp }}</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="text-right">
                  <p class="text-sm font-mono text-blue-600 dark:text-blue-400">
                    æˆåŠŸ: {{ record.stats.success }} | è·³é: {{ record.stats.skipped }} | å¤±æ•—: {{ record.stats.failed }}
                  </p>
                </div>
                <button
                  @click="deleteHistory(index)"
                  class="opacity-0 group-hover:opacity-100 px-2 py-1 bg-red-500/10 hover:bg-red-500/20 text-red-600 dark:text-red-400 text-xs rounded transition-all"
                  title="åˆªé™¤æ­¤è¨˜éŒ„"
                >
                  âœ•
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useGraphStore } from '../stores/graphStore';
import { ElMessage } from 'element-plus';

// ===== Stores =====
const graphStore = useGraphStore();

// ===== Refs =====
const fileInput = ref(null);
const selectedFile = ref(null);
const importMode = ref('new'); // 'new' | 'existing'
const graphName = ref('');
const selectedGraphId = ref(null);
const isUploading = ref(false);
const importHistory = ref([]);
const existingGraphs = ref([]);
const isLoadingGraphs = ref(false);
const uploadProgress = ref(0);
const filePreview = ref(null);

// ===== è¼‰å…¥ç¾æœ‰åœ–è­œåˆ—è¡¨ =====
const loadExistingGraphs = async () => {
  isLoadingGraphs.value = true;
  try {
    const response = await fetch('/api/graph/list');
    if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥åœ–è­œåˆ—è¡¨');
    
    const data = await response.json();
    existingGraphs.value = data.graphs || [];
    
    console.log('âœ… å·²è¼‰å…¥ç¾æœ‰åœ–è­œ:', existingGraphs.value.length, 'å€‹');
  } catch (error) {
    console.error('âŒ è¼‰å…¥åœ–è­œåˆ—è¡¨å¤±æ•—:', error);
    ElMessage.warning({
      message: 'âš ï¸ ç„¡æ³•è¼‰å…¥ç¾æœ‰åœ–è­œåˆ—è¡¨ï¼Œè«‹ç¨å¾Œå†è©¦',
      duration: 3000,
    });
    // ä½¿ç”¨é è¨­æ•¸æ“šä½œç‚ºå¾Œå‚™
    existingGraphs.value = [
      { id: 'default', name: 'é è¨­åœ–è­œ', nodeCount: 0 },
    ];
  } finally {
    isLoadingGraphs.value = false;
  }
};

// çµ„ä»¶æ›è¼‰æ™‚è¼‰å…¥åœ–è­œåˆ—è¡¨
onMounted(() => {
  loadExistingGraphs();
  
  // å¾ localStorage è¼‰å…¥æ­·å²è¨˜éŒ„
  const savedHistory = localStorage.getItem('importHistory');
  if (savedHistory) {
    try {
      importHistory.value = JSON.parse(savedHistory);
    } catch (e) {
      console.error('ç„¡æ³•è¼‰å…¥æ­·å²è¨˜éŒ„:', e);
    }
  }
});

// ===== Methods =====
const triggerFileInput = () => {
  fileInput.value.click();
};

const handleFileSelect = async (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const validExtensions = ['.csv', '.xlsx'];
  const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();

  if (!validExtensions.includes(fileExtension)) {
    ElMessage.warning({
      message: 'âš ï¸ åƒ…æ”¯æ´ CSV æˆ– Excel æª”æ¡ˆ',
      duration: 3000,
    });
    event.target.value = '';
    return;
  }

  // æª¢æŸ¥æª”æ¡ˆå¤§å° (æœ€å¤§ 50MB)
  const maxSize = 50 * 1024 * 1024; // 50MB
  if (file.size > maxSize) {
    ElMessage.warning({
      message: 'âš ï¸ æª”æ¡ˆå¤§å°è¶…é 50MBï¼Œè«‹é¸æ“‡è¼ƒå°çš„æª”æ¡ˆ',
      duration: 3000,
    });
    event.target.value = '';
    return;
  }

  selectedFile.value = file;
  console.log('ğŸ“„ å·²é¸æ“‡æª”æ¡ˆ:', file.name, 'å¤§å°:', formatFileSize(file.size));
  
  // å˜—è©¦é è¦½æª”æ¡ˆå…§å®¹
  await previewFile(file);
};

const clearFile = () => {
  selectedFile.value = null;
  filePreview.value = null;
  uploadProgress.value = 0;
  if (fileInput.value) {
    fileInput.value.value = '';
  }
};

// æª”æ¡ˆé è¦½åŠŸèƒ½
const previewFile = async (file) => {
  try {
    const reader = new FileReader();
    reader.onload = (e) => {
      const data = new Uint8Array(e.target.result);
      
      if (file.name.endsWith('.csv')) {
        const text = new TextDecoder('utf-8').decode(data);
        const lines = text.split('\n').slice(0, 5); // å‰5è¡Œ
        filePreview.value = {
          type: 'csv',
          headers: lines[0]?.split(',') || [],
          rows: lines.slice(1).map(line => line.split(',')),
        };
      } else {
        filePreview.value = {
          type: 'excel',
          message: 'Excel æª”æ¡ˆé è¦½æš«ä¸å¯ç”¨',
        };
      }
    };
    reader.readAsArrayBuffer(file);
  } catch (error) {
    console.warn('æª”æ¡ˆé è¦½å¤±æ•—:', error);
  }
};

const handleUpload = async () => {
  if (!selectedFile.value || isUploading.value) return;
  
  // é©—è­‰ï¼šæ–°å»ºæ¨¡å¼éœ€è¦åœ–è­œåç¨±
  if (importMode.value === 'new' && (!graphName.value || graphName.value.trim() === '')) {
    ElMessage.warning({
      message: 'âš ï¸ è«‹è¼¸å…¥åœ–è­œåç¨±',
      duration: 3000,
    });
    return;
  }
  
  // é©—è­‰ï¼šç¾æœ‰æ¨¡å¼éœ€è¦é¸æ“‡åœ–è­œ
  if (importMode.value === 'existing' && !selectedGraphId.value) {
    ElMessage.warning({
      message: 'âš ï¸ è«‹é¸æ“‡è¦åŠ å…¥çš„åœ–è­œ',
      duration: 3000,
    });
    return;
  }

  isUploading.value = true;
  uploadProgress.value = 0;

  const loadingMsg = ElMessage({
    message: 'â³ æ­£åœ¨ä¸Šå‚³ä¸¦è™•ç†æª”æ¡ˆ...',
    type: 'info',
    duration: 0,
  });

  // æ¨¡æ“¬é€²åº¦æ›´æ–°
  const progressInterval = setInterval(() => {
    if (uploadProgress.value < 90) {
      uploadProgress.value += Math.random() * 15;
    }
  }, 300);

  try {
    const formData = new FormData();
    formData.append('file', selectedFile.value);
    formData.append('import_mode', importMode.value);
    
    if (importMode.value === 'new') {
      formData.append('graph_name', graphName.value.trim());
      console.log('ğŸš€ é–‹å§‹ä¸Šå‚³æª”æ¡ˆ:', selectedFile.value.name);
      console.log('âœ¨ å»ºç«‹æ–°åœ–è­œ:', graphName.value.trim());
    } else {
      formData.append('graph_id', selectedGraphId.value.toString());
      const selectedGraph = existingGraphs.value.find(g => g.id === selectedGraphId.value);
      console.log('ğŸš€ é–‹å§‹ä¸Šå‚³æª”æ¡ˆ:', selectedFile.value.name);
      console.log('ğŸ“‚ åŠ å…¥åœ–è­œ:', selectedGraph?.name || selectedGraphId.value);
    }

    const response = await fetch('/api/graph/import/excel', {
      method: 'POST',
      body: formData,
    });

    clearInterval(progressInterval);
    uploadProgress.value = 100;

    if (!response.ok) {
      throw new Error(`HTTP Error: ${response.status}`);
    }

    const result = await response.json();
    console.log('âœ… å¾Œç«¯è¿”å›çµæœ:', result);

    if (!result.nodes || !Array.isArray(result.nodes)) {
      throw new Error('å¾Œç«¯è¿”å›çš„æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º');
    }

    const stats = graphStore.addBatchNodes(result.nodes);

    loadingMsg.close();
    
    const successMsg = importMode.value === 'new'
      ? `âœ… å·²å»ºç«‹åœ–è­œã€Œ${graphName.value.trim()}ã€ï¼æˆåŠŸ: ${stats.success}, è·³é: ${stats.skipped}, å¤±æ•—: ${stats.failed}`
      : `âœ… å·²åŠ å…¥åœ–è­œï¼æˆåŠŸ: ${stats.success}, è·³é: ${stats.skipped}, å¤±æ•—: ${stats.failed}`;
    
    ElMessage.success({
      message: successMsg,
      duration: 4000,
    });

    // è¨˜éŒ„å°å…¥æ­·å²
    const historyRecord = {
      fileName: selectedFile.value.name,
      mode: importMode.value,
      timestamp: new Date().toLocaleString('zh-TW'),
      success: true,
      stats: stats,
    };
    
    if (importMode.value === 'new') {
      historyRecord.graphName = graphName.value.trim();
    } else {
      const selectedGraph = existingGraphs.value.find(g => g.id === selectedGraphId.value);
      historyRecord.graphName = selectedGraph?.name || `åœ–è­œ #${selectedGraphId.value}`;
    }
    
    importHistory.value.unshift(historyRecord);

    // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡
    if (importHistory.value.length > 10) {
      importHistory.value = importHistory.value.slice(0, 10);
    }

    // ä¿å­˜åˆ° localStorage
    localStorage.setItem('importHistory', JSON.stringify(importHistory.value));

    console.log('ğŸ‰ æª”æ¡ˆå°å…¥æˆåŠŸ:', stats);

    // æ¸…é™¤é¸æ“‡
    clearFile();
    graphName.value = '';
    selectedGraphId.value = null;

  } catch (error) {
    clearInterval(progressInterval);
    uploadProgress.value = 0;
    
    loadingMsg.close();
    
    // è©³ç´°éŒ¯èª¤è¨Šæ¯
    let errorMsg = 'âŒ å°å…¥å¤±æ•—';
    if (error.message.includes('HTTP Error')) {
      errorMsg += ': ä¼ºæœå™¨é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™æ˜¯å¦é‹è¡Œ';
    } else if (error.message.includes('æ ¼å¼ä¸æ­£ç¢º')) {
      errorMsg += ': æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹';
    } else {
      errorMsg += `: ${error.message}`;
    }
    
    ElMessage.error({
      message: errorMsg,
      duration: 5000,
    });

    // è¨˜éŒ„å¤±æ•—æ­·å²
    importHistory.value.unshift({
      fileName: selectedFile.value.name,
      timestamp: new Date().toLocaleString('zh-TW'),
      success: false,
      stats: { success: 0, skipped: 0, failed: 0 },
    });

    // ä¿å­˜å¤±æ•—è¨˜éŒ„
    localStorage.setItem('importHistory', JSON.stringify(importHistory.value));

    console.error('âŒ æª”æ¡ˆä¸Šå‚³å¤±æ•—:', error);
  } finally {
    clearInterval(progressInterval);
    isUploading.value = false;
  }
};

// åˆªé™¤æ­·å²è¨˜éŒ„
const deleteHistory = (index) => {
  importHistory.value.splice(index, 1);
  localStorage.setItem('importHistory', JSON.stringify(importHistory.value));
  ElMessage.success({
    message: 'å·²åˆªé™¤è¨˜éŒ„',
    duration: 2000,
  });
};

// æ¸…ç©ºæ‰€æœ‰æ­·å²
const clearAllHistory = () => {
  importHistory.value = [];
  localStorage.removeItem('importHistory');
  ElMessage.success({
    message: 'å·²æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„',
    duration: 2000,
  });
};

const formatFileSize = (bytes) => {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
};
</script>

<style scoped>
/* é‚Šæ¡†ç²—ç´°èª¿æ•´ */
.border-3 {
  border-width: 3px;
}

/* å‹•ç•«æ•ˆæœ */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
</style>
