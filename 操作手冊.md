# BruV Enterprise â€” æ“ä½œæ‰‹å†Š

> **ç‰ˆæœ¬**: v5.0 &nbsp;|&nbsp; **æœ€å¾Œæ›´æ–°**: 2026-02-14 &nbsp;|&nbsp; **é©ç”¨å°è±¡**: ç³»çµ±ç®¡ç†å“¡ / ç¶­é‹å·¥ç¨‹å¸«

---

## ç›®éŒ„

1. [ç³»çµ±æ¦‚è¦½](#1-ç³»çµ±æ¦‚è¦½)
2. [ç’°å¢ƒéœ€æ±‚](#2-ç’°å¢ƒéœ€æ±‚)
3. [å®‰è£éƒ¨ç½²](#3-å®‰è£éƒ¨ç½²)
4. [å•Ÿå‹•èˆ‡åœæ­¢](#4-å•Ÿå‹•èˆ‡åœæ­¢)
5. [é…ç½®ç®¡ç†](#5-é…ç½®ç®¡ç†)
6. [èªè­‰èˆ‡å­˜å–æ§åˆ¶](#6-èªè­‰èˆ‡å­˜å–æ§åˆ¶)
7. [API ç«¯é»åƒè€ƒ](#7-api-ç«¯é»åƒè€ƒ)
8. [æª”æ¡ˆç›£æ§èˆ‡è‡ªå‹•åŒ¯å…¥](#8-æª”æ¡ˆç›£æ§èˆ‡è‡ªå‹•åŒ¯å…¥)
9. [Saga è·¨ç³»çµ±äº‹å‹™](#9-saga-è·¨ç³»çµ±äº‹å‹™)
10. [ä»»å‹™ä½‡åˆ—](#10-ä»»å‹™ä½‡åˆ—)
11. [ç³»çµ±ç¶­è­·](#11-ç³»çµ±ç¶­è­·)
12. [Nginx åå‘ä»£ç†](#12-nginx-åå‘ä»£ç†)
13. [å¯è§€æ¸¬æ€§ (Observability)](#13-å¯è§€æ¸¬æ€§-observability)
14. [å‰ç«¯å»ºæ§‹èˆ‡éœæ…‹æ›è¼‰](#14-å‰ç«¯å»ºæ§‹èˆ‡éœæ…‹æ›è¼‰)
15. [Docker æœå‹™ç®¡ç†](#15-docker-æœå‹™ç®¡ç†)
16. [æ•…éšœæ’æŸ¥](#16-æ•…éšœæ’æŸ¥)
17. [å‚™ä»½èˆ‡é‚„åŸ](#17-å‚™ä»½èˆ‡é‚„åŸ)

---

## 1. ç³»çµ±æ¦‚è¦½

BruV Enterprise æ˜¯ä¼æ¥­ç´š AI æœå‹™æ•´åˆå¹³å°ï¼Œä»¥ FastAPI ç‚ºæ ¸å¿ƒï¼Œæ•´åˆï¼š

| å…ƒä»¶ | è§’è‰² | é è¨­ Port |
|------|------|----------|
| **FastAPI å¾Œç«¯** | API Gateway + æ¥­å‹™é‚è¼¯ | `8000` |
| **Vue 3 å‰ç«¯** | Glass UI æ“ä½œä»‹é¢ | `5173` (dev) / `8000` (prod) |
| **Dify** | å°è©±å¼ AI + Workflow | `5001` (API) / `82` (Web) |
| **RAGFlow** | æ–‡æª” RAG æª¢ç´¢å¼•æ“ | `9380` (API) / `81` (Web) |
| **KuzuDB** | åœ–å½¢è³‡æ–™åº« (åµŒå…¥å¼) | å…§åµŒ |
| **Elasticsearch** | RAGFlow å…¨æ–‡æœç´¢ | `9200` |
| **Nginx** | åå‘ä»£ç† + SSL + é™æµ | `80` / `443` |
| **Grafana** | ç›£æ§å„€è¡¨æ¿ | `3000` |
| **Loki + Promtail** | æ—¥èªŒèšåˆ | `3100` |
| **Ollama** | æœ¬åœ° LLM æ¨ç† (GPU ç›´é€š) | `11434` |

### æ¶æ§‹åœ–

```
  ç€è¦½å™¨ â”€â”€â†’ Nginx (:80/:443)
                â”‚
                â”œâ”€â”€â†’ FastAPI (:8000)
                â”‚       â”œâ”€â”€ KuzuDB (embedded)
                â”‚       â”œâ”€â”€ Saga Orchestrator
                â”‚       â”œâ”€â”€ Task Queue (SQLite)
                â”‚       â””â”€â”€ File Watcher
                â”‚
                â”œâ”€â”€â†’ Dify (:5001)
                â”œâ”€â”€â†’ RAGFlow (:9380)
                â”‚       â””â”€â”€ Elasticsearch (:9200)
                â””â”€â”€â†’ Ollama (:11434, GPU)
```

---

## 2. ç’°å¢ƒéœ€æ±‚

### ç¡¬é«”æœ€ä½éœ€æ±‚

| é …ç›® | æœ€ä½ | å»ºè­° |
|------|------|------|
| CPU | 4 æ ¸å¿ƒ | 8 æ ¸å¿ƒä»¥ä¸Š |
| è¨˜æ†¶é«” | 16 GB | 32 GB |
| ç£ç¢Ÿ | 50 GB SSD | 200 GB NVMe SSD |
| GPU | â€” | RTX 4060+ (æœ¬åœ° LLM æ¨ç†) |

> **æ‰¹é‡åŒ¯å…¥ 3000 ç­†å»ºè­°**ï¼šRTX 4070 Super (12GB VRAM) + 32GB DDR5 ä»¥ä¸Šã€‚

### è»Ÿé«”éœ€æ±‚

| è»Ÿé«” | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Python | â‰¥ 3.10 | å¾Œç«¯ |
| Node.js | â‰¥ 18 | å‰ç«¯å»ºæ§‹ |
| Docker + Compose | â‰¥ 24.x | Dify / RAGFlow / å¯è§€æ¸¬æ€§ |
| Git | â‰¥ 2.x | ç‰ˆæœ¬ç®¡ç† |

### è³‡æ–™ç›®éŒ„

ç³»çµ±é è¨­å°‡æ‰€æœ‰æŒä¹…åŒ–è³‡æ–™å­˜æ”¾æ–¼ï¼š

```
C:\Users\<username>\BruV_Data\
â”œâ”€â”€ config.json          # åŸ·è¡Œéšæ®µé…ç½®
â”œâ”€â”€ auth_token.json      # Token å„²å­˜ (SHA-256 hash)
â”œâ”€â”€ kuzu_db/             # KuzuDB åœ–å½¢è³‡æ–™åº«
â”œâ”€â”€ saga_log.db          # Saga äº‹å‹™æ—¥èªŒ (SQLite)
â”œâ”€â”€ saga_dlq.db          # Dead Letter Queue (SQLite)
â”œâ”€â”€ task_queue.db        # ä»»å‹™ä½‡åˆ— (SQLite)
â”œâ”€â”€ Auto_Import/         # è‡ªå‹•åŒ¯å…¥ç›£æ§ç›®éŒ„
â””â”€â”€ media_library/       # åª’é«”åº«
```

> å¯é€éç’°å¢ƒè®Šæ•¸ `BRUV_DATA_DIR` è‡ªè¨‚æ ¹ç›®éŒ„ã€‚

---

## 3. å®‰è£éƒ¨ç½²

### 3.1 å…‹éš†å°ˆæ¡ˆ

```powershell
git clone <repo-url> BruV_Project
cd BruV_Project
```

### 3.2 å»ºç«‹ Python è™›æ“¬ç’°å¢ƒ

```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
```

### 3.3 å®‰è£å‰ç«¯ä¾è³´

```powershell
cd frontend
npm install
cd ..
```

### 3.4 é…ç½®ç’°å¢ƒè®Šæ•¸

```powershell
copy .env.example .env
notepad .env   # å¡«å…¥å¿…è¦è®Šæ•¸ï¼ˆè¦‹ç¬¬ 5 ç¯€ï¼‰
```

### 3.5 é…ç½® API é‡‘é‘°

```powershell
copy config.json.example C:\Users\$env:USERNAME\BruV_Data\config.json
notepad C:\Users\$env:USERNAME\BruV_Data\config.json
```

å¡«å…¥ï¼š

```json
{
  "dify_api_key": "app-xxxxxxxxxxxxxxxx",
  "dify_api_url": "http://localhost:5001/v1",
  "ragflow_api_key": "ragflow-xxxxxxxxxxxxxxxx",
  "ragflow_api_url": "http://localhost:9380/api/v1"
}
```

### 3.6 å•Ÿå‹• Docker ä¾è³´æœå‹™

```powershell
docker-compose up -d
```

---

## 4. å•Ÿå‹•èˆ‡åœæ­¢

### 4.1 ä¸€éµå•Ÿå‹•ï¼ˆæ¨è–¦ï¼‰

```
é›™æ“Š START.bat æˆ– START.ps1
```

å•Ÿå‹•é¸å–®ï¼š

| é¸é … | èªªæ˜ |
|------|------|
| 1 â€” GUI å•Ÿå‹•å™¨ | åœ–å½¢åŒ–ä»‹é¢ï¼Œæ¨è–¦ |
| 2 â€” å¿«é€Ÿå•Ÿå‹• | å¾Œç«¯ + å‰ç«¯ |
| 3 â€” åƒ…å¾Œç«¯ | åªå•Ÿå‹• API |
| 4 â€” å®Œæ•´ç³»çµ± | Docker + å¾Œç«¯ + å‰ç«¯ |

### 4.2 æ‰‹å‹•å•Ÿå‹•

```powershell
# å¾Œç«¯
cd BruV_Project
.\.venv\Scripts\Activate.ps1
python -m uvicorn app_anytype:app --host 127.0.0.1 --port 8000

# å‰ç«¯ (å¦é–‹çµ‚ç«¯)
cd BruV_Project\frontend
npm run dev
```

### 4.3 ç”Ÿç”¢æ¨¡å¼

```powershell
# 1. å»ºæ§‹å‰ç«¯éœæ…‹æª”æ¡ˆ
cd frontend
npx vite build       # ç”¢å‡º frontend/dist/
cd ..

# 2. åƒ…å•Ÿå‹•å¾Œç«¯ (å·²å« SPA æ›è¼‰)
$env:BRUV_API_TOKEN = "ä½ çš„ç”Ÿç”¢Token"
python -m uvicorn app_anytype:app --host 0.0.0.0 --port 8000

# è¨ªå• http://localhost:8000 å³å¯ä½¿ç”¨å®Œæ•´åŠŸèƒ½
```

### 4.4 åœæ­¢æœå‹™

```powershell
# åœæ­¢æ‰€æœ‰ Python ç¨‹åº
Get-Process -Name "python" -ErrorAction SilentlyContinue | Stop-Process -Force

# åœæ­¢ Docker æœå‹™
docker-compose down
```

### 4.5 å•Ÿå‹•æµç¨‹ (Lifespan) è©³ç´°é †åº

å¾Œç«¯å•Ÿå‹•æ™‚ä¾åºåŸ·è¡Œï¼š

1. **TaskQueue** â€” `task_queue.start_worker()`
2. **httpx é€£ç·šæ± ** â€” `AsyncClient(max_connections=50, keepalive=10)`
3. **KuzuDB** â€” `KuzuDBManager â†’ AsyncKuzuWrapper`ï¼ˆå¤±æ•—å›é€€ MockKuzuManagerï¼‰
4. **WatcherService** â€” å•Ÿå‹•æª”æ¡ˆç›£æ§ `Auto_Import/`
5. **åˆå§‹åŒ–èªè­‰** â€” `initialize_auth_token()`
6. **å°±ç·’æ—¥èªŒ** â€” è¼¸å‡º Dify/RAGFlow API URL

é—œé–‰æ™‚åå‘åŸ·è¡Œï¼šTaskQueue â†’ Watcher â†’ KuzuDB â†’ httpxã€‚

---

## 5. é…ç½®ç®¡ç†

### 5.1 é…ç½®å„ªå…ˆç´š

```
config.jsonï¼ˆåŸ·è¡Œéšæ®µï¼‰ > ç’°å¢ƒè®Šæ•¸ï¼ˆ.envï¼‰ > ç¨‹å¼ç¢¼é è¨­å€¼
```

> **æ³¨æ„**ï¼š`config.json` ä½¿ç”¨ `utf-8-sig` ç·¨ç¢¼è®€å–ï¼Œæ”¯æ´å« BOM çš„ UTF-8 æª”æ¡ˆã€‚è‹¥é‡åˆ°é…ç½®ç„¡æ³•è®€å–ï¼Œè«‹ç¢ºä¿æª”æ¡ˆç‚ºæœ‰æ•ˆ JSON æ ¼å¼ã€‚

### 5.2 ä¸»è¦ç’°å¢ƒè®Šæ•¸

| è®Šæ•¸ | é è¨­å€¼ | èªªæ˜ |
|------|--------|------|
| `BRUV_API_TOKEN` | (è‡ªå‹•ç”Ÿæˆ) | API èªè­‰ Token |
| `BRUV_HOST` | `127.0.0.1` | å¾Œç«¯ç¶å®š IP |
| `BRUV_PORT` | `8000` | å¾Œç«¯ Port |
| `BRUV_AUTH_ENABLED` | `True` | å•Ÿç”¨/åœç”¨èªè­‰ |
| `DEBUG` | `false` | é™¤éŒ¯æ¨¡å¼ |
| `LOG_LEVEL` | `INFO` | æ—¥èªŒç­‰ç´š |
| `BRUV_DATA_DIR` | `~/BruV_Data` | è³‡æ–™æ ¹ç›®éŒ„ |
| `DIFY_API_URL` | `http://localhost:5001/v1` | Dify API ä½å€ |
| `RAGFLOW_API_URL` | `http://localhost:9380/api/v1` | RAGFlow API ä½å€ |
| `KUZU_DB_PATH` | `~/BruV_Data/kuzu_db` | KuzuDB è·¯å¾‘ |
| `AUTO_IMPORT_DIR` | `~/BruV_Data/Auto_Import` | è‡ªå‹•åŒ¯å…¥ç›®éŒ„ |
| `MAX_UPLOAD_SIZE` | `100` (MB) | ä¸Šå‚³é™åˆ¶ |
| `REQUEST_TIMEOUT` | `30` (ç§’) | HTTP è¶…æ™‚ |
| `OTEL_ENABLED` | `false` | OpenTelemetry å•Ÿç”¨ |
| `OTEL_EXPORTER` | `console` | OTel åŒ¯å‡ºï¼š`console` / `otlp` |

### 5.3 åŸ·è¡Œéšæ®µä¿®æ”¹é…ç½®

```bash
# é€é API ä¿®æ”¹
PUT /api/system/config
Authorization: Bearer <token>
Content-Type: application/json

{
  "dify_api_key": "app-new-key",
  "ragflow_api_key": "ragflow-new-key"
}
```

é…ç½®æª” `config.json` ä½¿ç”¨åŸå­æ€§å¯«å…¥ï¼ˆtmp â†’ renameï¼‰ï¼Œç·šç¨‹å®‰å…¨ã€‚

---

## 6. èªè­‰èˆ‡å­˜å–æ§åˆ¶

### 6.1 èªè­‰æ©Ÿåˆ¶

- **Token æ ¼å¼**: SHA-256 é›œæ¹Šå„²å­˜ï¼Œæ˜æ–‡æ°¸ä¸è½åœ°
- **å„²å­˜è·¯å¾‘**: `~/BruV_Data/auth_token.json` (é€é `BRUV_DATA_DIR` ç’°å¢ƒè®Šæ•¸å¯è‡ªè¨‚)
- **æ”¯æ´å¤šçµ„ Token**: å¯ç‚ºä¸åŒä½¿ç”¨è€… / æœå‹™ç™¼æ”¾ç¨ç«‹ Token

### 6.2 åˆå§‹åŒ– Token

é¦–æ¬¡å•Ÿå‹•æ™‚ï¼Œè‹¥æœªè¨­å®š `BRUV_API_TOKEN`ï¼Œç³»çµ±è‡ªå‹•ç”Ÿæˆéš¨æ©Ÿ Token ä¸¦åœ¨ Console é¡¯ç¤ºä¸€æ¬¡ï¼š

```
============================================================
ğŸ”‘ é¦–æ¬¡å•Ÿå‹• - å·²è‡ªå‹•ç”Ÿæˆ API Token:
   dF3k8...ï¼ˆ44 å­—å…ƒï¼‰
   è«‹å¦¥å–„ä¿å­˜æ­¤ Tokenï¼Œå®ƒä¸æœƒå†æ¬¡é¡¯ç¤ºï¼
============================================================
```

**å»ºè­°**: è¨­å®šç’°å¢ƒè®Šæ•¸å›ºå®š Tokenï¼š

```powershell
$env:BRUV_API_TOKEN = "YourSecureToken"
```

### 6.3 API è«‹æ±‚èªè­‰

ä¸‰ç¨®æ–¹å¼æ”œå¸¶ Tokenï¼ˆæŒ‰å„ªå…ˆé †åºï¼‰ï¼š

```bash
# æ–¹å¼ 1: Authorization Headerï¼ˆæ¨è–¦ï¼‰
curl -H "Authorization: Bearer <token>" http://localhost:8000/api/system/config

# æ–¹å¼ 2: x-api-token Header
curl -H "x-api-token: <token>" http://localhost:8000/api/system/config

# æ–¹å¼ 3: URL Queryï¼ˆåƒ…ä¾›æ¸¬è©¦ï¼‰
curl http://localhost:8000/api/system/config?token=<token>
```

### 6.4 å…èªè­‰è·¯å¾‘

| è·¯å¾‘ | èªªæ˜ |
|------|------|
| `/` | å‰ç«¯é¦–é  |
| `/docs` / `/redoc` | Swagger æ–‡ä»¶ |
| `/openapi.json` | OpenAPI spec |
| `/api/health` | å¥åº·æª¢æŸ¥ |
| `/api/auth/login` | ç™»å…¥ |
| `/assets/*` | éœæ…‹è³‡æº |
| `/favicon*` | åœ–ç¤º |
| æ‰€æœ‰é `/api/` è·¯å¾‘ | SPA å‰ç«¯é é¢ |

### 6.5 å¤š Token ç®¡ç†

```python
from backend.core.auth import add_token, revoke_token, list_tokens

# æ–°å¢ä½¿ç”¨è€… Token
add_token(label="user_alice", token="alice-secret-token-xyz", role="user")

# æ–°å¢æœå‹™ Token
add_token(label="service_etl", token="etl-service-key-abc", role="service")

# åˆ—å‡ºæ‰€æœ‰ Token
list_tokens()
# â†’ [
#     {"label": "admin", "role": "admin", "created_at": "...", "hash_prefix": "ede49464..."},
#     {"label": "user_alice", "role": "user", "created_at": "...", "hash_prefix": "7f3a2b81..."},
# ]

# æ’¤éŠ· Token
revoke_token("user_alice")
```

**Token è§’è‰²**ï¼š

| è§’è‰² | èªªæ˜ |
|------|------|
| `admin` | å®Œå…¨æ¬Šé™ï¼ŒåŒ…å«ç³»çµ±ç¶­è­· |
| `user` | ä¸€èˆ¬æ“ä½œï¼ˆæŸ¥è©¢ã€åŒ¯å…¥ï¼‰ |
| `service` | æœå‹™å°æœå‹™èªè­‰ |

> ç›®å‰è§’è‰²åƒ…ç‚ºæ¨™è¨˜ï¼Œå°šæœªå¯¦ä½œç´°ç²’åº¦æ¬Šé™æ§åˆ¶ï¼ˆPhase 3 è¦åŠƒï¼‰ã€‚

---

## 7. API ç«¯é»åƒè€ƒ

### 7.1 ç³»çµ±ç®¡ç†

| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| `GET` | `/api/system/config` | å–å¾—é…ç½® |
| `PUT` | `/api/system/config` | æ›´æ–°é…ç½® |
| `GET` | `/api/system/env-file` | å–å¾— .env ç‹€æ…‹ |
| `POST` | `/api/system/test-connection` | æ¸¬è©¦å¤–éƒ¨æœå‹™é€£ç·š |
| `POST` | `/api/system/upload` | ä¸Šå‚³æª”æ¡ˆ |
| `GET` | `/api/system/circuit-breakers` | æ–·è·¯å™¨ç‹€æ…‹ |
| `GET` | `/api/system/saga-dlq` | DLQ æ­»ä¿¡ä½‡åˆ— |
| `POST` | `/api/system/saga-dlq/{id}/resolve` | æ¨™è¨˜ DLQ å·²è§£æ±º |
| `POST` | `/api/system/maintenance/cleanup` | æ¸…ç†éæœŸè¨˜éŒ„ |

### 7.2 çŸ¥è­˜åœ–è­œ

| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| `POST` | `/api/graph/metadata` | å»ºç«‹åœ–è­œ |
| `GET` | `/api/graph/metadata` | åˆ—å‡ºåœ–è­œ |
| `GET` | `/api/graph/{id}/entities` | æŸ¥è©¢å¯¦é«” |
| `POST` | `/api/graph/{id}/entities` | æ–°å¢å¯¦é«” |
| `DELETE` | `/api/graph/{id}/entities/{eid}` | åˆªé™¤å¯¦é«” |
| `POST` | `/api/graph/import` | åŒ¯å…¥åœ–è­œè³‡æ–™ |

### 7.3 Dify AI

| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| `POST` | `/api/dify/chat` | å°è©± |
| `POST` | `/api/dify/workflow` | åŸ·è¡Œ Workflow |

### 7.4 RAGFlow çŸ¥è­˜åº«

| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| `GET` | `/api/ragflow/datasets` | åˆ—å‡ºçŸ¥è­˜åº« |
| `POST` | `/api/ragflow/documents/upload` | ä¸Šå‚³æ–‡æª” |
| `POST` | `/api/ragflow/retrieval` | æª¢ç´¢ |

### 7.5 åª’é«”åº«

| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| `GET` | `/api/media/files` | åˆ—å‡ºæª”æ¡ˆ |
| `POST` | `/api/media/upload` | ä¸Šå‚³åª’é«” |
| `DELETE` | `/api/media/files/{id}` | åˆªé™¤æª”æ¡ˆ |

### 7.6 ä»»å‹™ä½‡åˆ—

| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| `GET` | `/api/tasks` | åˆ—å‡ºä»»å‹™ |
| `GET` | `/api/tasks/{id}` | æŸ¥è©¢ä»»å‹™ç‹€æ…‹ |

> å®Œæ•´æ–‡ä»¶ï¼šå•Ÿå‹•å¾Œç«¯ â†’ ç€è¦½ `http://localhost:8000/docs`

### 7.7 æ‰¹é‡åŒ¯å…¥ (Graph Import) â€” v5.0

é€é `/api/graph/import` ç«¯é»ï¼Œå¯å°‡ Excel/CSV æª”æ¡ˆæ‰¹é‡åŒ¯å…¥ç‚ºçŸ¥è­˜åœ–è­œç¯€é»ã€‚

**ä½¿ç”¨æ–¹å¼**ï¼š

```bash
POST /api/graph/import
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <Excel/CSV æª”æ¡ˆ>
graph_id: <ç›®æ¨™åœ–è­œ ID>
dataset_id: <RAGFlow çŸ¥è­˜åº« ID>
fast_mode: true   # å¯é¸ï¼Œ>100 ç­†è‡ªå‹•å•Ÿç”¨
```

**ä¸‰å¤§ LLM æ™ºèƒ½ç­–ç•¥**ï¼š

| ç­–ç•¥ | èªªæ˜ | æ•ˆæœ |
|------|------|------|
| æ¬„ä½æ™ºèƒ½æå– | åŒ¹é… Excel æ¬„åï¼ˆæ¨™é¡Œâ†’labelã€é¡å‹â†’typeã€æè¿°â†’descriptionã€é—œéµè©â†’keywordsï¼‰ï¼Œç›´æ¥è·³é LLM | æœ‰å°æ‡‰æ¬„ä½çš„è³‡æ–™ 100% å… LLM |
| LLM çµæœå¿«å– | MD5 é›œæ¹Šå»é‡ï¼Œç›¸åŒå…§å®¹è·¨æ‰¹æ¬¡åªå‘¼å«ä¸€æ¬¡ LLMï¼ˆä¸Šé™ 10K ç­†ï¼‰ | Fast mode ä¸‹å•Ÿç”¨ |
| è‡ªé©æ‡‰å¤§æ‰¹æ¬¡ | Fast mode ä½¿ç”¨ `TARGET_BATCH_TOKENS_FAST=6000`ï¼Œæ¯æ‰¹å¯è™•ç† ~30 è¡Œ | ~3x ååé‡æå‡ |

**RAGFlow åˆä½µä¸Šå‚³**ï¼šåŒ¯å…¥å®Œæˆå¾ŒæŒ‰ç¯€é»é¡å‹åˆ†çµ„ï¼Œåˆä½µæˆ 5-10 å€‹çµæ§‹åŒ– `.md` æ–‡ä»¶ä¸Šå‚³è‡³ RAGFlowã€‚è¶…é 200KB çš„æ–‡ä»¶æœƒè‡ªå‹•åˆ†å‰²ã€‚

**é—œéµåƒæ•¸**ï¼š

| åƒæ•¸ | å€¼ | èªªæ˜ |
|------|------|------|
| `MAX_CONCURRENCY` | 2 | æœ¬åœ° Ollama GPU ä½µç™¼ä¸Šé™ |
| `LLM_TIMEOUT` | 300s | å–®æ¬¡ LLM å‘¼å«è¶…æ™‚ |
| `TARGET_BATCH_TOKENS` | 2000 | ä¸€èˆ¬æ¨¡å¼æ¯æ‰¹ token |
| `TARGET_BATCH_TOKENS_FAST` | 6000 | å¿«é€Ÿæ¨¡å¼æ¯æ‰¹ token |
| `BATCH_DELAY` | 1.0s | æ‰¹æ¬¡é–“å»¶é²ï¼ˆGPU å†·å»ï¼‰ |
| `MAX_RAGFLOW_FILE_BYTES` | 200KB | RAGFlow æ–‡ä»¶åˆ†å‰²é–¾å€¼ |
| `_TASK_EXPIRY_SECONDS` | 7200 | ä»»å‹™éæœŸæ™‚é–“ï¼ˆ2 å°æ™‚ï¼‰ |

**æ”¯æ´è¦æ¨¡**ï¼šæœ€å¤š 3000 ç­†è³‡æ–™ï¼ˆéœ€ RTX 4070 Super æˆ–åŒç­‰ GPU + 32GB RAMï¼‰ã€‚

---

## 8. æª”æ¡ˆç›£æ§èˆ‡è‡ªå‹•åŒ¯å…¥

### 8.1 é‹ä½œæ©Ÿåˆ¶

ç³»çµ±å•Ÿå‹•å¾Œï¼Œ`WatcherService` æœƒä»¥ `watchdog` éè¿´ç›£æ§ `Auto_Import/` ç›®éŒ„ï¼š

```
C:\Users\<username>\BruV_Data\Auto_Import\
â”œâ”€â”€ å ±å‘ŠA.pdf        â† æ”¾å…¥å¾Œè‡ªå‹•è§¸ç™¼åŒ¯å…¥
â”œâ”€â”€ æ•¸æ“šè¡¨.xlsx      â† æ”¯æ´ Excel æ·±åº¦è§£æ
â””â”€â”€ å­ç›®éŒ„/
    â””â”€â”€ ç­†è¨˜.md      â† éè¿´ç›£æ§å­ç›®éŒ„
```

### 8.2 æ”¯æ´æ ¼å¼

| æ ¼å¼ | èªªæ˜ |
|------|------|
| `.txt` | ç´”æ–‡å­— |
| `.pdf` | PDF æ–‡æª” |
| `.docx` | Word æ–‡æª” |
| `.xlsx` | Excelï¼ˆè§¸ç™¼ Step 3 æ·±åº¦è§£æï¼‰ |
| `.md` | Markdown |

### 8.3 è™•ç†æµç¨‹

```
æ–°æª”æ¡ˆåµæ¸¬ â†’ Saga è·¨ç³»çµ±äº‹å‹™:
  Step 1: ä¸Šå‚³è‡³ RAGFlow çŸ¥è­˜åº«
  Step 2: å¯«å…¥ KuzuDB åœ–è­œ
  Step 3: Excel æ·±åº¦è§£æ (å¯é¸)
```

### 8.4 æ‰‹å‹•è§¸ç™¼

```powershell
# å°‡æª”æ¡ˆè¤‡è£½åˆ°ç›£æ§ç›®éŒ„å³å¯è‡ªå‹•è§¸ç™¼
Copy-Item "C:\path\to\report.pdf" "$env:USERPROFILE\BruV_Data\Auto_Import\"
```

---

## 9. Saga è·¨ç³»çµ±äº‹å‹™

### 9.1 è¨­è¨ˆåŸç†

æ¡ç”¨ **Saga Orchestration** æ¨¡å¼ï¼Œç¢ºä¿ RAGFlow â†” KuzuDB è³‡æ–™ä¸€è‡´æ€§ï¼š

```
æ­£å¸¸æµç¨‹:
  ragflow_upload â†’ kuzu_write â†’ excel_parse (optional)
  
å¤±æ•—æ™‚åå‘è£œå„Ÿ:
  comp_kuzu_delete â† comp_ragflow_delete
```

### 9.2 ç‹€æ…‹æ©Ÿ

```
NOT_STARTED â†’ STARTED â†’ COMPLETED
                    â†˜ FAILED â†’ COMPENSATING â†’ COMPENSATION_COMPLETE
                                           â†˜ COMPENSATION_FAILED â†’ DLQ
```

### 9.3 æŸ¥è©¢ Saga è¨˜éŒ„

```powershell
# é€é Python CLI
python -c "
from backend.services.saga import list_recent_sagas
for s in list_recent_sagas(10):
    print(f'{s[\"saga_id\"]} | {s[\"status\"]} | {s[\"file_path\"]}')
"
```

### 9.4 DLQ (Dead Letter Queue)

è£œå„Ÿå¤±æ•—çš„æ“ä½œæœƒé€²å…¥ DLQï¼Œéœ€ç®¡ç†å“¡æ‰‹å‹•è™•ç†ï¼š

```bash
# æŸ¥çœ‹ DLQ
GET /api/system/saga-dlq
Authorization: Bearer <token>

# æ¨™è¨˜å·²è§£æ±º
POST /api/system/saga-dlq/{dlq_id}/resolve
Authorization: Bearer <token>
```

**é‡è©¦åƒæ•¸**: æœ€å¤š 3 æ¬¡ï¼ŒæŒ‡æ•¸é€€é¿ (2s â†’ 4s â†’ 8s)ã€‚

---

## 10. ä»»å‹™ä½‡åˆ—

### 10.1 æ¶æ§‹

```
API Request â†’ TaskQueue.enqueue() â†’ SQLite â†’ Worker (async loop)
                                                 â†“
                                          åŸ·è¡Œä»»å‹™å›å‘¼
                                                 â†“
                                          æ›´æ–°é€²åº¦ / å®Œæˆ
```

- **æŒä¹…åŒ–**: `~/BruV_Data/task_queue.db` (SQLite)
- **è‡ªå‹•æ¸…ç†**: è¶…é 500 ç­†æ­·å²è¨˜éŒ„æ™‚è‡ªå‹•æ¸…ç†æœ€èˆŠçš„å·²å®Œæˆ / å¤±æ•—ä»»å‹™
- **æœªä¾†æ“´å±•**: è¨­å®š `TASK_BACKEND=celery` + `CELERY_BROKER_URL=redis://...` åˆ‡æ›è‡³ Celery

### 10.2 ç›£æ§ä»»å‹™

```bash
# åˆ—å‡ºæœ€è¿‘ä»»å‹™
GET /api/tasks
Authorization: Bearer <token>

# æŸ¥è©¢ç‰¹å®šä»»å‹™
GET /api/tasks/{task_id}
Authorization: Bearer <token>
```

---

## 11. ç³»çµ±ç¶­è­·

### 11.1 æ¸…ç†éæœŸè¨˜éŒ„

```bash
# æ¸…ç†è¶…é 7 å¤©çš„å·²å®Œæˆ Saga / Task è¨˜éŒ„ï¼ˆDLQ ä¿ç•™ï¼‰
POST /api/system/maintenance/cleanup
Authorization: Bearer <token>

# è‡ªè¨‚ä¿ç•™å¤©æ•¸
POST /api/system/maintenance/cleanup?retention_days=30
```

å›æ‡‰ç¯„ä¾‹ï¼š

```json
{
  "success": true,
  "message": "æ¸…ç†å®Œæˆ: SagaLog 12 ç­†, TaskQueue 45 ç­† (DLQ ä¿ç•™ä¸å‹•)",
  "data": {
    "saga_deleted": 12,
    "task_deleted": 45,
    "retention_days": 7,
    "cutoff": "2026-02-04T12:00:00"
  }
}
```

### 11.2 DLQ è™•ç†

```powershell
# 1. æŸ¥çœ‹ DLQ é …ç›®
Invoke-RestMethod -Uri "http://localhost:8000/api/system/saga-dlq" `
  -Headers @{"Authorization"="Bearer <token>"}

# 2. æ‰‹å‹•ä¿®å¾©å¾Œæ¨™è¨˜å·²è§£æ±º
Invoke-RestMethod -Uri "http://localhost:8000/api/system/saga-dlq/{id}/resolve" `
  -Method POST -Headers @{"Authorization"="Bearer <token>"}
```

### 11.3 æ–·è·¯å™¨ç›£æ§

```bash
GET /api/system/circuit-breakers
Authorization: Bearer <token>
```

å›å‚³å„ä¸‹æ¸¸æœå‹™ (Dify / RAGFlow) çš„æ–·è·¯å™¨ç‹€æ…‹ï¼š

| ç‹€æ…‹ | èªªæ˜ |
|------|------|
| `CLOSED` | æ­£å¸¸é‹ä½œ |
| `OPEN` | æ–·è·¯ä¸­ï¼Œæ‹’çµ•è«‹æ±‚ |
| `HALF_OPEN` | å˜—è©¦æ¢å¾©ä¸­ |

### 11.4 æ—¥èªŒæŸ¥çœ‹

å¾Œç«¯è¼¸å‡º JSON çµæ§‹åŒ–æ—¥èªŒï¼š

```json
{
  "timestamp": "2026-02-11 12:00:00",
  "level": "INFO",
  "logger": "bruv.access",
  "message": "GET /api/graph/metadata â†’ 200 (3.5ms)",
  "request_id": "a1b2c3d4",
  "trace_id": "0af7651916cd43dd",       // OTel å•Ÿç”¨æ™‚
  "span_id": "b7ad6b7169203331",        // OTel å•Ÿç”¨æ™‚
  "duration_ms": 3.5,
  "status_code": 200,
  "method": "GET",
  "path": "/api/graph/metadata",
  "client_ip": "127.0.0.1"
}
```

---

## 12. Nginx åå‘ä»£ç†

### 12.1 é…ç½®ä½ç½®

```
BruV_Project/nginx/ragflow.conf
```

æ­¤æª”æ¡ˆé€é Docker volume æ›è¼‰è‡³ RAGFlow å®¹å™¨çš„ Nginxã€‚

### 12.2 IP ç™½åå–®

é è¨­åªå…è¨±å€ç¶² IP å­˜å–ï¼š

```nginx
geo $ip_whitelist {
    default         0;       # é è¨­æ‹’çµ•
    127.0.0.0/8     1;       # localhost
    10.0.0.0/8      1;       # 10.x.x.x å…§ç¶²
    172.16.0.0/12   1;       # 172.16-31.x.x å…§ç¶²
    192.168.0.0/16  1;       # 192.168.x.x å…§ç¶²
}
```

**é–‹æ”¾ç‰¹å®šå¤–éƒ¨ IP**ï¼š

```nginx
    203.0.113.50/32  1;     # åŠ å…¥æ­¤è¡Œ
```

**é–‹æ”¾æ‰€æœ‰ IP**ï¼ˆä¸å»ºè­°ï¼‰ï¼š

```nginx
geo $ip_whitelist {
    default  1;
}
```

### 12.3 é€Ÿç‡é™åˆ¶

| Zone | é™åˆ¶ | ç”¨é€” |
|------|------|------|
| `api` | 30 req/s, burst=50 | ä¸€èˆ¬ API |
| `upload` | 5 req/s, burst=10 | æª”æ¡ˆä¸Šå‚³ |

### 12.4 HTTPS / SSL

```nginx
ssl_certificate     /etc/nginx/ssl/cert.pem;
ssl_certificate_key /etc/nginx/ssl/key.pem;
```

å°‡æ†‘è­‰æ”¾å…¥ `nginx/ssl/` ç›®éŒ„ï¼ŒDocker Compose æœƒè‡ªå‹•æ›è¼‰ã€‚

è‡ªç°½æ†‘è­‰ç”¢ç”Ÿï¼ˆæ¸¬è©¦ç”¨ï¼‰ï¼š

```powershell
openssl req -x509 -newkey rsa:2048 -keyout nginx/ssl/key.pem `
  -out nginx/ssl/cert.pem -days 365 -nodes `
  -subj "/CN=bruv-local"
```

### 12.5 å®‰å…¨æ¨™é ­

| Header | å€¼ |
|--------|-----|
| `X-Frame-Options` | `DENY` |
| `X-Content-Type-Options` | `nosniff` |
| `X-XSS-Protection` | `1; mode=block` |
| `Strict-Transport-Security` | `max-age=31536000` (HTTPS) |
| `Content-Security-Policy` | é™åˆ¶ `default-src 'self'` (HTTPS) |

---

## 13. å¯è§€æ¸¬æ€§ (Observability)

### 13.1 å…ƒä»¶

| å…ƒä»¶ | ç”¨é€” | Port | è¨˜æ†¶é«”é™åˆ¶ |
|------|------|------|-----------|
| Loki | æ—¥èªŒèšåˆ | `3100` | 256 MB |
| Promtail | æ—¥èªŒæ¡é›† | - | 128 MB |
| Grafana | å„€è¡¨æ¿ | `3000` | 256 MB |

### 13.2 Grafana å­˜å–

```
http://localhost:3000
å¸³è™Ÿ: admin
å¯†ç¢¼: bruv_adminï¼ˆé è¨­ï¼Œå¯é€é GRAFANA_ADMIN_PASSWORD ä¿®æ”¹ï¼‰
```

### 13.3 OpenTelemetry è¿½è¹¤

å•Ÿç”¨è¿½è¹¤ï¼š

```powershell
$env:OTEL_ENABLED = "true"
$env:OTEL_EXPORTER = "console"    # é–‹ç™¼ï¼šè¼¸å‡ºåˆ° console
# $env:OTEL_EXPORTER = "otlp"    # ç”Ÿç”¢ï¼šè¼¸å‡ºåˆ° Jaeger/Tempo
# $env:OTEL_OTLP_ENDPOINT = "http://localhost:4317"
```

è¿½è¹¤ç¯„åœï¼š

| å…ƒä»¶ | Span åç¨± | æ¥­å‹™ Attribute |
|------|-----------|---------------|
| Saga ä¸»æµç¨‹ | `saga.file_import` | `saga.id`, `saga.file_path`, `saga.graph_id` |
| RAGFlow ä¸Šå‚³ | `saga.step.ragflow_upload` | `saga.ragflow_doc_id` |
| KuzuDB å¯«å…¥ | `saga.step.kuzu_write` | `saga.entity_id` |
| Excel è§£æ | `saga.step.excel_parse` | â€” |
| è£œå„Ÿæµç¨‹ | `saga.compensate` | `saga.compensation_result` |
| HTTP è«‹æ±‚ | è‡ªå‹•æ³¨å…¥ | `http.method`, `http.url`, `http.status_code` |

---

## 14. å‰ç«¯å»ºæ§‹èˆ‡éœæ…‹æ›è¼‰

### 14.1 é–‹ç™¼æ¨¡å¼

```powershell
cd frontend
npm run dev          # http://localhost:5173 (HMR ç†±æ›´æ–°)
```

### 14.2 ç”Ÿç”¢å»ºæ§‹

```powershell
cd frontend
npx vite build       # ç”¢å‡º â†’ frontend/dist/
```

> **æ³¨æ„**: Node.js â‰¥ 24 æ­é… vite@5 å¯èƒ½ç™¼ç”Ÿ Rollup åŸç”Ÿæ¨¡çµ„å´©æ½°ï¼Œè«‹æ”¹ç”¨ `npx vite@6 build`ã€‚

### 14.3 å¾Œç«¯éœæ…‹æ›è¼‰

å»ºæ§‹å®Œæˆå¾Œï¼Œå¾Œç«¯è‡ªå‹•æ›è¼‰ `frontend/dist/`ï¼š

| è·¯å¾‘ | æœå‹™ |
|------|------|
| `/assets/*` | `StaticFiles(frontend/dist/assets/)` |
| `/{ä»»æ„è·¯å¾‘}` | SPA fallback â†’ `index.html` |
| `/api/*` | API è·¯ç”±ï¼ˆéœ€èªè­‰ï¼‰ |

ç”Ÿç”¢æ¨¡å¼åªéœ€å¾Œç«¯å–®ä¸€æœå‹™ port 8000 å³å¯åŒæ™‚æä¾› API + å‰ç«¯ã€‚

### 14.4 Vite å»ºæ§‹é…ç½®æ‘˜è¦

```javascript
// frontend/vite.config.js
build: {
    outDir: 'dist',
    assetsDir: 'assets',
    minify: 'esbuild',     // esbuild è¼ƒç©©å®š
    chunkSizeWarningLimit: 1500
}
```

---

## 15. Docker æœå‹™ç®¡ç†

### 15.1 å®Œæ•´å•Ÿå‹•

```powershell
cd BruV_Project
docker-compose up -d
```

### 15.2 æŸ¥çœ‹ç‹€æ…‹

```powershell
docker-compose ps
docker-compose logs -f --tail=50 ragflow
```

### 15.3 å€‹åˆ¥é‡å•Ÿ

```powershell
docker-compose restart ragflow
docker-compose restart dify-api
```

### 15.4 æ¸…ç†é‡å»º

```powershell
docker-compose down
docker volume prune -f    # âš ï¸ æœƒåˆªé™¤æ‰€æœ‰æœªä½¿ç”¨çš„ volume
docker-compose up -d
```

### 15.5 å®¹å™¨æ¸…å–®

| å®¹å™¨å | æ˜ åƒ | ç”¨é€” |
|--------|------|------|
| `bruv_dify_nginx` | `nginx:latest` | Dify åå‘ä»£ç† |
| `bruv_dify` | `langgenius/dify-web:0.6.16` | Dify å‰ç«¯ |
| `bruv_dify_api` | `langgenius/dify-api:0.6.16` | Dify API |
| `bruv_dify_worker` | `langgenius/dify-api:0.6.16` | Dify èƒŒæ™¯ Worker |
| `bruv_dify_db` | `postgres:15-alpine` | Dify è³‡æ–™åº« |
| `bruv_dify_redis` | `redis:7-alpine` | Dify å¿«å– |
| `bruv_ragflow` | `infiniflow/ragflow:v0.16.0` | RAGFlow ä¸»ç¨‹å¼ |
| `bruv_ragflow_mysql` | `mysql:8.0` | RAGFlow è³‡æ–™åº« |
| `bruv_ragflow_minio` | `minio/minio:latest` | RAGFlow ç‰©ä»¶å„²å­˜ |
| `bruv_ragflow_redis` | `redis:7-alpine` | RAGFlow å¿«å– |
| `es01` | `elasticsearch:8.11.3` | å…¨æ–‡æœç´¢å¼•æ“ |
| `bruv_ollama` | `ollama/ollama:latest` | æœ¬åœ° LLM (GPU ç›´é€š) |
| `bruv_loki` | `grafana/loki:2.9.0` | æ—¥èªŒèšåˆ |
| `bruv_promtail` | `grafana/promtail:2.9.0` | æ—¥èªŒæ¡é›† |
| `bruv_grafana` | `grafana/grafana:10.2.0` | ç›£æ§å„€è¡¨æ¿ |

---

## 16. æ•…éšœæ’æŸ¥

### 16.1 å¾Œç«¯ç„¡æ³•å•Ÿå‹•

| ç—‡ç‹€ | åŸå›  | è§£æ³• |
|------|------|------|
| `Could not import module "app_anytype"` | å·¥ä½œç›®éŒ„ä¸åœ¨ `BruV_Project/` | `cd BruV_Project` å¾Œé‡æ–°å•Ÿå‹• |
| `KuzuDB åˆå§‹åŒ–å¤±æ•—: Could not set lock` | å¦ä¸€å€‹ç¨‹åºä½”ç”¨ DB | åœæ­¢å…¶ä»– Python ç¨‹åº |
| `[Errno 10048] port 8000 already in use` | Port è¢«ä½”ç”¨ | `Get-NetTCPConnection -LocalPort 8000` æŸ¥çœ‹ä½”ç”¨è€… |
| Token ç›¸é—œ 401 | Token ä¸åŒ¹é… | æª¢æŸ¥ `BRUV_API_TOKEN` æˆ– `auth_token.json` |
| æ‰€æœ‰ç¯€é»ã€ŒLLM åˆ†æå¤±æ•—ã€ | `config.json` å« UTF-8 BOM â†’ API Key è§£æå¤±æ•— | ç”¨ä¸å« BOM çš„ç·¨è¼¯å™¨é‡æ–°å„²å­˜ `config.json`ï¼Œæˆ–ç¢ºèª config.py ä½¿ç”¨ `utf-8-sig` ç·¨ç¢¼ |

### 16.2 Docker ç›¸é—œ

| ç—‡ç‹€ | åŸå›  | è§£æ³• |
|------|------|------|
| RAGFlow å•Ÿå‹•å¤±æ•— | ç¼ºå°‘ `.env` è®Šæ•¸ | è¨­å®š `RAGFLOW_MYSQL_PASSWORD` ç­‰å¿…è¦è®Šæ•¸ |
| Elasticsearch OOM | è¨˜æ†¶é«”ä¸è¶³ | èª¿æ•´ `ES_JAVA_OPTS=-Xms512m -Xmx512m` |
| Dify é€£ä¸ä¸Š | API æœªå°±ç·’ | ç­‰å¾… `dify-api` å®Œå…¨å•Ÿå‹• (~30s) |

### 16.2.1 RAGFlow æ–‡ä»¶è§£æå¤±æ•— (FileNotFoundError)

**ç—‡ç‹€**: ä¸Šå‚³åˆ° RAGFlow çš„æ–‡ä»¶é¡¯ç¤º `RUNNING` å¾Œè®Šæˆ `FAIL`ï¼ŒéŒ¯èª¤è¨Šæ¯ç‚º `No such file or directory`ã€‚

**æ ¹å› **: MinIO ä¸­ç¼ºå°‘ `rag_flow` ä½¿ç”¨è€…ï¼Œå°è‡´ `STORAGE_IMPL.put()` éœé»˜å¤±æ•—ï¼Œæª”æ¡ˆå…§å®¹å¾æœªå¯«å…¥ MinIOã€‚

**ä¿®å¾©æ­¥é©Ÿ**:

```powershell
# 1. é€²å…¥ MinIO å®¹å™¨è¨­å®š mc alias
docker exec -it bruv_ragflow_minio sh -c "
  mc alias set local http://localhost:9000 minioadmin infiniflow
"

# 2. å»ºç«‹ rag_flow ä½¿ç”¨è€…
docker exec bruv_ragflow_minio mc admin user add local rag_flow infiniflow

# 3. æˆäºˆ readwrite æ¬Šé™
docker exec bruv_ragflow_minio mc admin policy attach local readwrite --user rag_flow

# 4. é©—è­‰
docker exec bruv_ragflow_minio mc admin user list local
```

> **æ³¨æ„**: ä¿®å¾©å‰ä¸Šå‚³çš„æ–‡ä»¶æ²’æœ‰ MinIO å…§å®¹ï¼Œéœ€è¦å¾ RAGFlow åˆªé™¤å¾Œé‡æ–°ä¸Šå‚³ã€‚

### 16.2.2 RAGFlow RAPTOR å¤±æ•— (NoneType not subscriptable)

**ç—‡ç‹€**: æ–‡ä»¶è§£ææˆåŠŸ (chunks > 0)ï¼Œä½† RAPTOR éšæ®µå ±éŒ¯ `Fail to bind LLM used by RAPTOR`ã€‚

**æ ¹å› **: Dataset å•Ÿç”¨äº† RAPTOR (use_raptor: true)ï¼Œä½† LLM æ¨¡å‹è¨­å®šä¸æ­£ç¢ºæˆ–ä¸å¯ç”¨ã€‚

**ä¿®å¾©**: é€é RAGFlow API é—œé–‰ RAPTORï¼š

```python
import httpx, json

RAGFLOW = 'http://localhost:9380/api/v1'
HEADERS = {'Authorization': 'Bearer <YOUR_API_KEY>', 'Content-Type': 'application/json'}
DATASET_ID = '<YOUR_DATASET_ID>'

r = httpx.get(f'{RAGFLOW}/datasets?id={DATASET_ID}', headers=HEADERS)
pc = r.json()['data'][0]['parser_config']
pc['raptor'] = {'use_raptor': False}
pc['graphrag'] = {'use_graphrag': False}

httpx.put(f'{RAGFLOW}/datasets/{DATASET_ID}', headers=HEADERS, json={'parser_config': pc})
```

### 16.3 å‰ç«¯å»ºæ§‹å¤±æ•—

| ç—‡ç‹€ | åŸå›  | è§£æ³• |
|------|------|------|
| Exit code `3221226505` | Rollup åŸç”Ÿæ¨¡çµ„å´©æ½° (Node 24) | ä½¿ç”¨ `npx vite@6 build` |
| `terser` crash | Terser è¨˜æ†¶é«”æº¢å‡º | `vite.config.js` æ”¹ `minify: 'esbuild'` |
| `npm install` å¤±æ•— | ç¶²è·¯ / æ¬Šé™ | æ¸…é™¤ `node_modules` é‡è©¦ |

### 16.4 æ‰¹é‡åŒ¯å…¥ç›¸é—œ

| ç—‡ç‹€ | åŸå›  | è§£æ³• |
|------|------|------|
| æ‰€æœ‰ç¯€é»ã€ŒLLM åˆ†æå¤±æ•—ã€ | config.json BOM / API Key ç„¡æ•ˆ | é©—è­‰ `config.json` ç·¨ç¢¼ï¼Œç¢ºèª Dify API Key æ­£ç¢ºå¯ç”¨ |
| å¤§é‡ç¯€é»é¡¯ç¤ºã€Œæœªæä¾›ã€ | GPU ä½µç™¼å¤ªé«˜å°è‡´ LLM timeout | é™ä½ `MAX_CONCURRENCY` (å»ºè­° 2)ï¼Œå¢åŠ  `LLM_TIMEOUT` (å»ºè­° 300s) |
| RAGFlow çŸ¥è­˜åº«æ–‡ä»¶æš´å¢ | æ¯è¡Œè³‡æ–™ç”¢ç”Ÿä¸€å€‹æ–‡ä»¶ | ç¢ºèªå·²ä½¿ç”¨ v5.0 åˆä½µä¸Šå‚³ï¼ˆæŒ‰é¡å‹åˆ†çµ„ï¼‰ |
| å‰ç«¯åŒ¯å…¥é€²åº¦å¡ä½ | è¼ªè©¢è¶…æ™‚æˆ–ä»»å‹™éæœŸ | ç¢ºèª `_TASK_EXPIRY_SECONDS=7200`ï¼Œå‰ç«¯è¼ªè©¢ä¸Šé™ 2400 æ¬¡ |
| è¨˜æ†¶é«”ä¸è¶³ (>1000 ç­†) | nodes é™£åˆ—ä½”ç”¨å¤§é‡ RAM | ç¢ºèª v5.0 ç‰ˆæœ¬å·²å¯¦ä½œ `del nodes` è¨˜æ†¶é«”é‡‹æ”¾ |

**æ¸…ç†å¤±æ•—ç¯€é»çš„ RAGFlow æ–‡ä»¶**ï¼š

```powershell
cd BruV_Project
../.venv/Scripts/python.exe -c "
import requests
base = 'http://localhost:9380/api/v1'
api_key = '<YOUR_RAGFLOW_API_KEY>'
ds_id = '<YOUR_DATASET_ID>'
headers = {'Authorization': f'Bearer {api_key}'}

# å–å¾—æ‰€æœ‰æ–‡ä»¶
page, all_ids = 1, []
while True:
    r = requests.get(f'{base}/datasets/{ds_id}/documents?page={page}&page_size=100', headers=headers, timeout=30)
    docs = r.json().get('data', {}).get('docs', [])
    if not docs: break
    all_ids.extend(d['id'] for d in docs)
    if len(docs) < 100: break
    page += 1
print(f'Total docs: {len(all_ids)}')

# æ‰¹é‡åˆªé™¤
if all_ids:
    r = requests.delete(f'{base}/datasets/{ds_id}/documents', headers=headers, json={'ids': all_ids}, timeout=60)
    print(f'Delete: {r.status_code}')
"
```

### 16.5 å¿«é€Ÿè¨ºæ–·å‘½ä»¤

```powershell
# æª¢æŸ¥å¾Œç«¯æ˜¯å¦æ´»è‘—
Invoke-RestMethod http://localhost:8000/api/health

# æª¢æŸ¥èªè­‰
Invoke-RestMethod http://localhost:8000/api/system/circuit-breakers `
  -Headers @{"Authorization"="Bearer <token>"}

# æª¢æŸ¥ Docker æœå‹™ç‹€æ…‹
docker-compose ps

# æª¢æŸ¥ port ä½”ç”¨
Get-NetTCPConnection -LocalPort 8000 -State Listen

# æª¢æŸ¥ KuzuDB é–å®š
Get-Process -Name "python" | Select-Object Id, StartTime
```

---

## 17. å‚™ä»½èˆ‡é‚„åŸ

### 17.1 éœ€è¦å‚™ä»½çš„è³‡æ–™

| è·¯å¾‘ | èªªæ˜ | é »ç‡å»ºè­° |
|------|------|---------|
| `~/BruV_Data/config.json` | åŸ·è¡Œéšæ®µé…ç½® | æ¯æ¬¡ä¿®æ”¹å¾Œ |
| `~/BruV_Data/auth_token.json` | Token å„²å­˜ | æ¯æ¬¡æ–°å¢ Token å¾Œ |
| `~/BruV_Data/kuzu_db/` | çŸ¥è­˜åœ–è­œè³‡æ–™ | æ¯æ—¥ |
| `~/BruV_Data/saga_log.db` | Saga æ—¥èªŒ | æ¯é€± |
| `~/BruV_Data/task_queue.db` | ä»»å‹™è¨˜éŒ„ | æ¯é€± |
| Docker volumes | Dify + RAGFlow è³‡æ–™ | æ¯é€± |
| `BruV_Project/.env` | ç’°å¢ƒè®Šæ•¸ | æ¯æ¬¡ä¿®æ”¹å¾Œ |

### 17.2 å‚™ä»½è…³æœ¬ç¯„ä¾‹

```powershell
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$backupDir = "C:\BruV_Backup\$timestamp"
New-Item -ItemType Directory -Path $backupDir -Force

# å‚™ä»½è³‡æ–™ç›®éŒ„
Copy-Item -Path "$env:USERPROFILE\BruV_Data" -Destination "$backupDir\BruV_Data" -Recurse

# å‚™ä»½ Docker volumes
docker run --rm -v bruv_project_ragflow_data:/data -v "${backupDir}:/backup" `
  alpine tar czf /backup/ragflow_data.tar.gz -C /data .

docker run --rm -v bruv_project_dify_storage:/data -v "${backupDir}:/backup" `
  alpine tar czf /backup/dify_storage.tar.gz -C /data .

Write-Host "âœ… å‚™ä»½å®Œæˆ: $backupDir"
```

### 17.3 é‚„åŸ

```powershell
$backupDir = "C:\BruV_Backup\20260211_120000"    # æŒ‡å®šå‚™ä»½æ—¥æœŸ

# åœæ­¢æœå‹™
docker-compose down
Get-Process -Name "python" -ErrorAction SilentlyContinue | Stop-Process -Force

# é‚„åŸè³‡æ–™
Copy-Item -Path "$backupDir\BruV_Data\*" -Destination "$env:USERPROFILE\BruV_Data" -Recurse -Force

# é‡æ–°å•Ÿå‹•
docker-compose up -d
python -m uvicorn app_anytype:app --host 127.0.0.1 --port 8000
```

---

## é™„éŒ„ A â€” å®Œæ•´æœå‹™å­˜å–åœ°å€

| æœå‹™ | URL | èªè­‰ |
|------|-----|------|
| å‰ç«¯ (é–‹ç™¼) | `http://localhost:5173` | â€” |
| å‰ç«¯ (ç”Ÿç”¢) | `http://localhost:8000` | â€” |
| API æ–‡ä»¶ | `http://localhost:8000/docs` | â€” |
| Dify Web | `http://localhost:82` | Dify å¸³å¯† |
| Dify API | `http://localhost:5001` | Dify API Key |
| RAGFlow Web | `http://localhost:81` | RAGFlow å¸³å¯† |
| RAGFlow API | `http://localhost:9380` | RAGFlow API Key |
| Grafana | `http://localhost:3000` | admin / bruv_admin |
| MinIO Console | `http://localhost:9001` | minioadmin / infiniflow |
| Elasticsearch | `http://localhost:9200` | â€” |
| Ollama | `http://localhost:11434` | â€” |

## é™„éŒ„ B â€” æª”æ¡ˆçµæ§‹

```
BruV_Project/
â”œâ”€â”€ app_anytype.py                  # FastAPI ä¸»ç¨‹å¼å…¥å£
â”œâ”€â”€ config.json.example             # é…ç½®ç¯„æœ¬
â”œâ”€â”€ docker-compose.yml              # Docker æœå‹™ç·¨æ’
â”œâ”€â”€ requirements.txt                # Python ä¾è³´
â”œâ”€â”€ START.bat / START.ps1           # ä¸€éµå•Ÿå‹•è…³æœ¬
â”œâ”€â”€ æ“ä½œæ‰‹å†Š.md                     # â† æœ¬æ–‡ä»¶
â”‚
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ api/                        # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ dify.py                 # Dify AI å°è©±
â”‚   â”‚   â”œâ”€â”€ ragflow.py              # RAGFlow çŸ¥è­˜åº«
â”‚   â”‚   â”œâ”€â”€ graph.py                # åœ–è­œ CRUD
â”‚   â”‚   â”œâ”€â”€ graph_import.py         # åœ–è­œåŒ¯å…¥
â”‚   â”‚   â”œâ”€â”€ system.py               # ç³»çµ±ç®¡ç† + ç¶­è­·
â”‚   â”‚   â”œâ”€â”€ tasks.py                # ä»»å‹™ä½‡åˆ— API
â”‚   â”‚   â””â”€â”€ media_library.py        # åª’é«”åº«
â”‚   â”œâ”€â”€ core/                       # æ ¸å¿ƒæ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ auth.py                 # èªè­‰ + å¤š Token
â”‚   â”‚   â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ kuzu_manager.py         # KuzuDB ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ logging.py              # çµæ§‹åŒ–æ—¥èªŒ
â”‚   â”‚   â””â”€â”€ telemetry.py            # OpenTelemetry
â”‚   â”œâ”€â”€ services/                   # æœå‹™å±¤
â”‚   â”‚   â”œâ”€â”€ saga.py                 # Saga ç·¨æ’å™¨
â”‚   â”‚   â”œâ”€â”€ task_queue.py           # ä»»å‹™ä½‡åˆ—
â”‚   â”‚   â””â”€â”€ watcher.py              # æª”æ¡ˆç›£æ§ + DLQ
â”‚   â””â”€â”€ utils/                      # å·¥å…·å‡½å¼
â”‚
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/                        # Vue 3 åŸå§‹ç¢¼
â”‚   â”œâ”€â”€ dist/                       # ç”Ÿç”¢å»ºæ§‹ç”¢å‡º
â”‚   â”œâ”€â”€ vite.config.js              # Vite é…ç½®
â”‚   â””â”€â”€ package.json                # å‰ç«¯ä¾è³´
â”‚
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ ragflow.conf                # Nginx é…ç½® (IP ç™½åå–® + é™æµ)
â”‚   â””â”€â”€ ssl/                        # SSL æ†‘è­‰
â”‚
â””â”€â”€ observability/
    â”œâ”€â”€ grafana-datasources.yml     # Grafana è³‡æ–™ä¾†æº
    â”œâ”€â”€ loki-config.yml             # Loki é…ç½®
    â””â”€â”€ promtail-config.yml         # Promtail é…ç½®
```
